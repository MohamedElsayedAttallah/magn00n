{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card p-4">
    <h2 class="text-center mb-4" style="color: #58a6ff;">ECG Viewer (Electrocardiography)</h2>

    <div id="drop-zone" class="dropzone mb-4">
        <p><strong>Drag and Drop your ECG .dat and .hea files here (both required)</strong> <br>
           <small class="text-secondary">Files will be converted to JSON on the server for client-side streaming.</small></p>
        <input type="file" id="ecg-file-input" accept=".dat,.hea" multiple hidden>
    </div>

    <div id="ecg-status" class="alert alert-info" role="alert">
        Awaiting file upload...
    </div>

    <div id="ecg-controls" class="row mb-4" style="display: none;">

        <div class="col-md-3">
            <label for="ecg-primary-ch" class="form-label">Primary Channels</label>
            <select id="ecg-primary-ch" class="form-select" multiple size="3"></select>
        </div>

        <div class="col-md-3">
            <label for="ecg-pair-ch" class="form-label">Pair Channel (for XOR/Rec.)</label>
            <select id="ecg-pair-ch" class="form-select"></select>
        </div>

        <div class="col-md-3 d-flex align-items-end justify-content-between">
            <button id="ecg-btn-play" class="btn btn-success flex-fill me-2" disabled>
                <i class="fas fa-play"></i> ▶ Play
            </button>
            <button id="ecg-btn-pause" class="btn btn-warning flex-fill me-2" disabled>
                <i class="fas fa-pause"></i> ⸗ Pause
            </button>
            <button id="ecg-btn-reset" class="btn btn-danger flex-fill" disabled>
                Reset (New Fs)
            </button>
        </div>

        <div class="col-md-3" id="ecg-time-slider-container">
            <label for="ecg-time-slider" class="form-label">Window: <span id="window-size-output">5.0</span> sec</label>
            <input type="range" class="form-range" min="1" max="10" step="0.5" value="5" id="ecg-time-slider">
        </div>
    </div>

     <!-- Replace the detection section and style in your ecg.html with this -->

<!-- Detection Button Container (initially hidden) -->
<div id="ecg-detection-container" class="text-center mb-4" style="display: none;">
    <button id="ecg-btn-detect" class="btn btn-primary btn-lg" style="min-width: 200px;" disabled>
        <i class="fas fa-heartbeat"></i> Detect Abnormality
    </button>
    <p class="text-muted mt-2 mb-0">
        <small>Uses PTB-XL trained model (100Hz only)</small>
    </p>
</div>

<!-- Detection Results Card -->
<div id="ecg-detection-results" class="card mb-4" style="display: none; background-color: #161b22; border: 1px solid #30363d;">
    <div class="card-body">
        <h5 class="card-title" style="color: #58a6ff;">
            <i class="fas fa-chart-line"></i> Detection Results
        </h5>
        <div id="ecg-detection-content">
            <!-- Results will be populated here -->
        </div>
    </div>
</div>

    <div id="ecg-nyquist-slider-container" class="mb-4" style="display: none;">
        <label for="ecg-nyquist-slider" class="form-label">Simulated Sampling FS ($f_s$): <span id="nyquist-fs-output">500</span> Hz (Nyquist Limit: <span id="max-freq-output">250</span> Hz)</label>
        <input type="range" class="form-range" min="0" max="500" step="10" value="500" id="ecg-nyquist-slider">
    </div>

    <hr style="border-color: #30363d;">

    <div id="ecg-mode-buttons" class="text-center mb-4" style="display: none;">
        <h4 class="mb-3" style="color: #c9d1d9;">Visualization Mode</h4>
        <button class="btn btn-mode me-2 active" data-mode="linear">1. Linear Waveform</button>
        <button class="btn btn-mode me-2" data-mode="xor">2. XOR Detection</button>
        <button class="btn btn-mode me-2" data-mode="polar">3. Polar View</button>
        <button class="btn btn-mode" data-mode="recurrence">4. Recurrence Map</button>
    </div>


    <div id="ecg-plots" style="min-height: 500px;">
        <div class="graph-container">
            <h5 class="text-light" id="current-plot-title">1. Linear Waveform (<span id="linear-time-window">0-5s</span>)</h5>
            <div id="ecg-single-plot" style="height: 450px;"></div>
        </div>
    </div>
</div>


<style>
    /* Styling for the mode buttons */
    .btn-mode {
        background-color: #30363d;
        color: #c9d1d9;
        border: 1px solid #30363d;
    }
    .btn-mode:hover {
        background-color: #50555c;
        color: white;
    }
    .btn-mode.active {
        background-color: #58a6ff;
        border-color: #58a6ff;
        color: white;
        box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
    }

    /* Detection button styling */
    #ecg-btn-detect {
        background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    #ecg-btn-detect:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
    }
    #ecg-btn-detect:disabled {
        background: #30363d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Detection results styling */
    .detection-result-normal {
        background-color: rgba(40, 167, 69, 0.1);
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 5px;
    }
    .detection-result-abnormal {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
        padding: 15px;
        border-radius: 5px;
    }
    .probability-bar {
        height: 25px;
        background-color: #30363d;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
        margin: 5px 0;
    }
    .probability-fill {
        height: 100%;
        background: linear-gradient(90deg, #58a6ff, #1f6feb);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
    }
    .probability-label {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 600;
        color: #c9d1d9;
        z-index: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="{% static 'js/ecg_logic.js' %}"></script>
{% endblock %}